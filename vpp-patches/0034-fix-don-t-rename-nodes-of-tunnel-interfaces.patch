From b617a40fd4542f273ca2f59bcd93f9c4cdc9e2bf Mon Sep 17 00:00:00 2001
From: Marcin Zyla <marcin.zyla@vprocess.pl>
Date: Wed, 17 Sep 2025 13:00:28 +0200
Subject: [PATCH] fix: don't rename nodes of tunnel interfaces

---
 src/plugins/gre/gre.c     |  1 +
 src/plugins/vxlan/vxlan.c |  1 +
 src/vnet/interface.c      | 19 +++++++++++++------
 src/vnet/interface.h      |  3 +++
 4 files changed, 18 insertions(+), 6 deletions(-)

diff --git a/src/plugins/gre/gre.c b/src/plugins/gre/gre.c
index fee81c2b4..60dde73d7 100644
--- a/src/plugins/gre/gre.c
+++ b/src/plugins/gre/gre.c
@@ -763,6 +763,7 @@ VNET_DEVICE_CLASS (gre_device_class) = {
   .format_tx_trace = format_gre_tx_trace,
   .admin_up_down_function = gre_interface_admin_up_down,
   .ip_tun_desc = gre_tunnel_desc,
+  .is_tunnel = 1,
 #ifdef SOON
   .clear counter = 0;
 #endif
diff --git a/src/plugins/vxlan/vxlan.c b/src/plugins/vxlan/vxlan.c
index f1ab7a7cb..5c59cb728 100644
--- a/src/plugins/vxlan/vxlan.c
+++ b/src/plugins/vxlan/vxlan.c
@@ -134,6 +134,7 @@ VNET_DEVICE_CLASS (vxlan_device_class, static) = {
   .format_device_name = format_vxlan_name,
   .format_tx_trace = format_vxlan_encap_trace,
   .admin_up_down_function = vxlan_interface_admin_up_down,
+  .is_tunnel = 1,
 };
 /* *INDENT-ON* */
 
diff --git a/src/vnet/interface.c b/src/vnet/interface.c
index db47d42c8..44f23ff9a 100644
--- a/src/vnet/interface.c
+++ b/src/vnet/interface.c
@@ -1149,9 +1149,9 @@ vnet_delete_hw_interface (vnet_main_t * vnm, u32 hw_if_index)
 	}
 
       vlib_node_rename (vm, hw->output_node_index,
-			"interface-%d-output-deleted", hw_if_index);
-      vlib_node_rename (vm, hw->tx_node_index, "interface-%d-tx-deleted",
-			hw_if_index);
+			"interface-%d-%d-output-deleted", hw_if_index, hw->output_node_index);
+      vlib_node_rename (vm, hw->tx_node_index, "interface-%d-%d-tx-deleted",
+			hw_if_index, hw->tx_node_index);
       vlib_unregister_errors (vm, hw->output_node_index);
       vlib_unregister_errors (vm, hw->tx_node_index);
       vec_add2 (im->deleted_hw_interface_nodes, dn, 1);
@@ -1577,9 +1577,16 @@ vnet_rename_interface (vnet_main_t * vnm, u32 hw_if_index, char *new_name)
   hash_unset_mem (im->hw_interface_by_name, old_name);
   hash_set_mem (im->hw_interface_by_name, hw->name, hw_if_index);
 
-  /* rename tx/output nodes */
-  vlib_node_rename (vm, hw->tx_node_index, "%v-tx", hw->name);
-  vlib_node_rename (vm, hw->output_node_index, "%v-output", hw->name);
+  vnet_device_class_t *dev_class =
+    vnet_get_device_class (vnm, hw->dev_class_index);
+
+  /* only rename nodes of non-tunnel ifaces */
+  if (!dev_class->is_tunnel)
+    {
+      /* rename tx/output nodes */
+      vlib_node_rename (vm, hw->tx_node_index, "%v-tx", hw->name);
+      vlib_node_rename (vm, hw->output_node_index, "%v-output", hw->name);
+    }
 
   /* rename statseg directory */
   statseg_interface_rename (vnm, hw->sw_if_index);
diff --git a/src/vnet/interface.h b/src/vnet/interface.h
index f0cb540f9..d9c2a596b 100644
--- a/src/vnet/interface.h
+++ b/src/vnet/interface.h
@@ -290,6 +290,9 @@ typedef struct _vnet_device_class
   /* Interface to set rss queues of the interface */
   vnet_interface_rss_queues_set_t *set_rss_queues_function;
 
+  /* Interfaces of this device share nodes, so dont rename them*/
+  u8 is_tunnel;
+
 } vnet_device_class_t;
 
 u32 vnet_register_device_class (vlib_main_t *, vnet_device_class_t *);
-- 
2.51.0

