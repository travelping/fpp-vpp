From ac199fcd9ba16a9dc3657f8ee02c2a2c82a65417 Mon Sep 17 00:00:00 2001
From: Sergey Matov <sergey.matov@travelping.com>
Date: Mon, 23 Nov 2020 21:35:28 +0400
Subject: [PATCH] vppinfra: fix memory leak in sparse_vec_free()

Type: fix

Signed-off-by: Ivan Shvedunov <ivan4th@gmail.com>
Signed-off-by: Sergey Matov <sergey.matov@travelping.com>
Change-Id: I4ec1a68b7266f05ab7c543cd8207afb29e740743
---
 src/vppinfra/sparse_vec.h | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/vppinfra/sparse_vec.h b/src/vppinfra/sparse_vec.h
index 1f57d304e..3bd440d5d 100644
--- a/src/vppinfra/sparse_vec.h
+++ b/src/vppinfra/sparse_vec.h
@@ -225,7 +225,10 @@ sparse_vec_index2 (void *v,
     {                                                                         \
       if (V)                                                                  \
 	{                                                                     \
-	  clib_mem_free (sparse_vec_header (V));                              \
+	  sparse_vec_header_t *_h = sparse_vec_header (V);                    \
+	  vec_free (_h->is_member_bitmap);                                    \
+	  vec_free (_h->member_counts);                                       \
+	  clib_mem_free (_h);                                                 \
 	  V = 0;                                                              \
 	}                                                                     \
     }                                                                         \
-- 
2.32.0 (Apple Git-132)

